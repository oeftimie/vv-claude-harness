#!/bin/bash
# Harness init.sh - Multi-language build/test smoke test
# Generated by harness v3.1
# This script verifies the project builds and tests pass before work begins.

set -e

PROJECT_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
cd "$PROJECT_ROOT"

echo "=== Harness Smoke Test ==="
echo "Project: $PROJECT_ROOT"
echo "Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
echo ""

detect_stack() {
    if [ -f "Package.swift" ] || ls *.xcodeproj 1>/dev/null 2>&1; then
        echo "swift"
    elif [ -f "package.json" ]; then
        echo "node"
    elif [ -f "pyproject.toml" ] || [ -f "requirements.txt" ] || [ -f "setup.py" ]; then
        echo "python"
    elif [ -f "go.mod" ]; then
        echo "go"
    elif [ -f "Cargo.toml" ]; then
        echo "rust"
    else
        echo "unknown"
    fi
}

if [ -f ".harness/harness.json" ]; then
    STACK=$(cat .harness/harness.json | grep -o '"stack"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*"stack"[[:space:]]*:[[:space:]]*"\([^"]*\)"/\1/')
fi

if [ -z "$STACK" ] || [ "$STACK" = "null" ]; then
    STACK=$(detect_stack)
fi

echo "Stack: $STACK"
echo ""

case "$STACK" in
    swift|ios|macos)
        echo "--- Swift/Xcode Build ---"
        if [ -f "Package.swift" ]; then
            swift build 2>&1 | tail -5
            echo ""
            echo "--- Swift Tests ---"
            swift test 2>&1 | tail -20
        elif ls *.xcodeproj 1>/dev/null 2>&1; then
            SCHEME=$(xcodebuild -list 2>/dev/null | grep -A 100 "Schemes:" | tail -n +2 | head -1 | xargs)
            if [ -n "$SCHEME" ]; then
                xcodebuild test -scheme "$SCHEME" -destination 'platform=macOS' 2>&1 | tail -20
            else
                echo "WARNING: No scheme detected. Run xcodebuild -list to check."
            fi
        fi
        ;;
    node|nodejs|javascript|typescript)
        echo "--- Node.js Build ---"
        if [ -f "package-lock.json" ]; then
            npm ci 2>&1 | tail -5
        elif [ -f "yarn.lock" ]; then
            yarn install --frozen-lockfile 2>&1 | tail -5
        elif [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile 2>&1 | tail -5
        else
            npm install 2>&1 | tail -5
        fi
        if [ -f "tsconfig.json" ]; then
            echo ""
            echo "--- TypeScript Check ---"
            npx tsc --noEmit 2>&1 | tail -10
        fi
        echo ""
        echo "--- Tests ---"
        npm test 2>&1 | tail -20
        ;;
    python)
        echo "--- Python Setup ---"
        if [ -f "pyproject.toml" ]; then
            pip install -e ".[dev]" --quiet 2>&1 | tail -5
        elif [ -f "requirements.txt" ]; then
            pip install -r requirements.txt --quiet 2>&1 | tail -5
        fi
        echo ""
        echo "--- Python Tests ---"
        if command -v pytest &>/dev/null; then
            pytest --tb=short --cov 2>&1 | tail -20
        elif [ -f "manage.py" ]; then
            python manage.py test 2>&1 | tail -20
        else
            python -m unittest discover 2>&1 | tail -20
        fi
        ;;
    go|golang)
        echo "--- Go Build ---"
        go build ./... 2>&1 | tail -5
        echo ""
        echo "--- Go Tests ---"
        go test -cover ./... 2>&1 | tail -20
        ;;
    rust)
        echo "--- Rust Build ---"
        cargo build 2>&1 | tail -5
        echo ""
        echo "--- Rust Tests ---"
        cargo test 2>&1 | tail -20
        ;;
    *)
        echo "WARNING: Unknown stack '$STACK'"
        if [ -f "Makefile" ] && grep -q "test" Makefile; then
            echo "Found Makefile with test target"
            make test 2>&1 | tail -20
        elif [ -f "Justfile" ] && grep -q "test" Justfile; then
            echo "Found Justfile with test target"
            just test 2>&1 | tail -20
        else
            echo "No test runner detected. Skipping tests."
            echo "Configure stack in .harness/harness.json to enable."
        fi
        ;;
esac

echo ""
echo "=== Smoke Test Complete ==="
