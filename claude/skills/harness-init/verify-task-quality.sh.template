#!/bin/bash
# Harness v3.2 - TaskCompleted quality gate hook
# Runs when a teammate marks a task as complete.
# Exit code 0 = accept completion
# Exit code 2 = reject completion, send feedback to teammate

set -euo pipefail

PROJECT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$PROJECT_ROOT"

# Read hook input from stdin
INPUT=$(cat)

# Run the project's test suite
echo "Running test suite..." >&2
if [ -f ".harness/init.sh" ]; then
    TEST_OUTPUT=$(bash .harness/init.sh 2>&1) || {
        echo "Task rejected: tests are failing. Fix the failures before marking complete."
        echo ""
        echo "Test output (last 20 lines):"
        echo "$TEST_OUTPUT" | tail -20
        exit 2
    }
fi

# Check that features.json hasn't been left stale
if [ -f ".harness/features.json" ]; then
    IN_PROGRESS=$(cat .harness/features.json | python3 -c "
import json, sys
data = json.load(sys.stdin)
in_progress = [f for f in data.get('features', []) if f['status'] == 'in-progress']
print(len(in_progress))
" 2>/dev/null || echo "0")
    if [ "$IN_PROGRESS" -gt 0 ]; then
        echo "Note: $IN_PROGRESS feature(s) still marked in-progress. Update features.json if your feature is complete."
    fi
fi

# All checks passed
exit 0
